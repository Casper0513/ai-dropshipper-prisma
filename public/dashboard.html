<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DropBopp Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind via CDN (for quick styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <style>
      body {
        background-color: #020617; /* slate-950-ish */
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: rgba(100, 116, 139, 0.8);
        border-radius: 9999px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: transparent;
      }
    </style>
  </head>
  <body class="min-h-screen text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // --------- Small helpers ----------
      async function safeJsonFetch(url, options) {
        try {
          const res = await fetch(url, options);
          if (!res.ok) {
            throw new Error(\`HTTP \${res.status}\`);
          }
          const data = await res.json();
          return { ok: true, data };
        } catch (err) {
          console.error("Request failed:", url, err);
          return { ok: false, error: err };
        }
      }

      function formatDate(value) {
        if (!value) return "–";
        try {
          const d = new Date(value);
          if (Number.isNaN(d.getTime())) return "–";
          return d.toLocaleString();
        } catch {
          return String(value);
        }
      }

      function classNames(...parts) {
        return parts.filter(Boolean).join(" ");
      }

      // --------- Overview cards ----------
      function StatCard({ label, value, hint }) {
        return (
          <div className="bg-slate-900/70 border border-slate-800 rounded-2xl p-4 flex flex-col gap-1 shadow-lg shadow-black/30">
            <div className="text-xs uppercase tracking-wide text-slate-400">
              {label}
            </div>
            <div className="text-2xl font-semibold text-slate-50">
              {value ?? "–"}
            </div>
            {hint && (
              <div className="text-xs text-slate-500 truncate">{hint}</div>
            )}
          </div>
        );
      }

      // --------- Tabs ----------
      function Tabs({ active, onChange }) {
        const tabs = [
          { id: "overview", label: "Overview" },
          { id: "runs", label: "Import Runs" },
          { id: "profit", label: "Profit & Pricing" },
          { id: "alerts", label: "Alerts" },
          { id: "settings", label: "Settings" },
        ];

        return (
          <div className="inline-flex items-center rounded-full bg-slate-900/80 border border-slate-800 p-1">
            {tabs.map((t) => (
              <button
                key={t.id}
                onClick={() => onChange(t.id)}
                className={classNames(
                  "px-3 py-1 text-xs sm:text-sm rounded-full transition-all",
                  active === t.id
                    ? "bg-sky-500 text-white shadow-md shadow-sky-500/30"
                    : "text-slate-400 hover:text-slate-100 hover:bg-slate-800"
                )}
              >
                {t.label}
              </button>
            ))}
          </div>
        );
      }

      // --------- Run Import panel ----------
      function ManualImportPanel({ onImported }) {
        const [keyword, setKeyword] = useState("");
        const [mode, setMode] = useState("search");
        const [source, setSource] = useState("amazon");
        const [markup, setMarkup] = useState("");
        const [loading, setLoading] = useState(false);
        const [message, setMessage] = useState(null);
        const [error, setError] = useState(null);

        async function handleSubmit(e) {
          e.preventDefault();
          setError(null);
          setMessage(null);

          if (!keyword.trim()) {
            setError("Keyword is required.");
            return;
          }

          setLoading(true);
          const payload = {
            keyword: keyword.trim(),
            mode,
            source: source || "dashboard",
            markupPercent: markup ? Number(markup) : undefined,
          };

          // Try new /api/sync/run first
          const primary = await safeJsonFetch("/api/sync/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (primary.ok && primary.data) {
            setMessage(
              \`Sync started for "\${keyword.trim()}" (created: \${primary.data.createdCount ?? "?"})\`
            );
            setLoading(false);
            onImported && onImported();
            return;
          }

          // Fallback to legacy /api/import
          const fallback = await safeJsonFetch("/api/import", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              keyword: keyword.trim(),
              mode,
              markupPercent: payload.markupPercent,
              source: "dashboard",
            }),
          });

          if (fallback.ok) {
            setMessage(
              \`Legacy import triggered for "\${keyword.trim()}". Check recent runs for progress.\`
            );
          } else {
            setError(
              "Failed to trigger import via both /api/sync/run and /api/import."
            );
          }

          setLoading(false);
          onImported && onImported();
        }

        return (
          <div className="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5 flex flex-col gap-3">
            <div className="flex items-center justify-between gap-2">
              <h2 className="text-sm font-semibold text-slate-100">
                Run Import
              </h2>
              <span className="text-[10px] uppercase text-slate-500">
                Manual trigger
              </span>
            </div>

            <form
              onSubmit={handleSubmit}
              className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3"
            >
              <div className="flex flex-col gap-1">
                <label className="text-xs text-slate-400">Keyword / ASIN</label>
                <input
                  className="bg-slate-950/70 border border-slate-700 rounded-xl px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-1 focus:ring-sky-500"
                  placeholder="e.g. wireless earbuds"
                  value={keyword}
                  onChange={(e) => setKeyword(e.target.value)}
                />
              </div>

              <div className="flex flex-col gap-1">
                <label className="text-xs text-slate-400">Mode</label>
                <select
                  className="bg-slate-950/70 border border-slate-700 rounded-xl px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-1 focus:ring-sky-500"
                  value={mode}
                  onChange={(e) => setMode(e.target.value)}
                >
                  <option value="search">Search</option>
                  <option value="product-offers">Product offers</option>
                  <option value="product-details">Product details</option>
                </select>
              </div>

              <div className="flex flex-col gap-1">
                <label className="text-xs text-slate-400">Source</label>
                <select
                  className="bg-slate-950/70 border border-slate-700 rounded-xl px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-1 focus:ring-sky-500"
                  value={source}
                  onChange={(e) => setSource(e.target.value)}
                >
                  <option value="amazon">Amazon (RapidAPI)</option>
                  <option value="aliexpress">AliExpress</option>
                  <option value="walmart">Walmart</option>
                  <option value="auto">Auto (multi-source)</option>
                </select>
              </div>

              <div className="flex flex-col gap-1">
                <label className="text-xs text-slate-400">
                  Markup % (optional)
                </label>
                <input
                  type="number"
                  step="1"
                  min="0"
                  className="bg-slate-950/70 border border-slate-700 rounded-xl px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-1 focus:ring-sky-500"
                  placeholder="e.g. 35"
                  value={markup}
                  onChange={(e) => setMarkup(e.target.value)}
                />
              </div>

              <div className="sm:col-span-2 lg:col-span-4 flex items-center justify-between mt-1">
                <div className="flex items-center gap-2 text-xs">
                  <span className="text-slate-500">
                    This will create products in Shopify after AI processing.
                  </span>
                </div>
                <button
                  type="submit"
                  disabled={loading}
                  className={classNames(
                    "inline-flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-semibold",
                    loading
                      ? "bg-slate-700 text-slate-300 cursor-wait"
                      : "bg-sky-500 hover:bg-sky-400 text-white shadow-md shadow-sky-500/30"
                  )}
                >
                  {loading ? "Running…" : "Run Import"}
                </button>
              </div>
            </form>

            {message && (
              <div className="text-xs text-emerald-400 bg-emerald-950/40 border border-emerald-800 rounded-xl px-3 py-2">
                {message}
              </div>
            )}
            {error && (
              <div className="text-xs text-rose-400 bg-rose-950/40 border border-rose-800 rounded-xl px-3 py-2">
                {error}
              </div>
            )}
          </div>
        );
      }

      // --------- Overview section ----------
      function OverviewSection({ overview, profit }) {
        const totalProducts = overview?.totalProducts ?? "–";
        const totalRuns = overview?.totalRuns ?? "–";
        const avgProfit =
          profit?.totals?.marginPercent != null
            ? profit.totals.marginPercent.toFixed(1) + "%"
            : "–";
        const lastSync = overview?.lastSyncAt
          ? formatDate(overview.lastSyncAt)
          : "Never";

        return (
          <div className="flex flex-col gap-4">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <StatCard
                label="Total Shopify products"
                value={totalProducts}
                hint="Products created through DropBopp imports"
              />
              <StatCard
                label="Total import runs"
                value={totalRuns}
                hint="Successful runs logged in database"
              />
              <StatCard
                label="Average profit margin"
                value={avgProfit}
                hint="Based on recent pricing data"
              />
              <StatCard
                label="Last sync"
                value={lastSync}
                hint="Time of last completed sync"
              />
            </div>

            <div className="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5">
              <div className="flex items-center justify-between gap-2 mb-3">
                <h2 className="text-sm font-semibold">Profit snapshot</h2>
                <span className="text-[11px] text-slate-500">
                  Last 30 days (if available)
                </span>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-4 gap-4 text-sm">
                <div>
                  <div className="text-xs text-slate-500 uppercase">
                    Revenue
                  </div>
                  <div className="text-lg font-semibold">
                    $
                    {profit?.totals?.revenue != null
                      ? profit.totals.revenue.toFixed(2)
                      : "0.00"}
                  </div>
                </div>
                <div>
                  <div className="text-xs text-slate-500 uppercase">Cost</div>
                  <div className="text-lg font-semibold">
                    $
                    {profit?.totals?.cost != null
                      ? profit.totals.cost.toFixed(2)
                      : "0.00"}
                  </div>
                </div>
                <div>
                  <div className="text-xs text-slate-500 uppercase">
                    Profit
                  </div>
                  <div className="text-lg font-semibold text-emerald-400">
                    $
                    {profit?.totals?.profit != null
                      ? profit.totals.profit.toFixed(2)
                      : "0.00"}
                  </div>
                </div>
                <div>
                  <div className="text-xs text-slate-500 uppercase">
                    Margin
                  </div>
                  <div className="text-lg font-semibold">
                    {profit?.totals?.marginPercent != null
                      ? profit.totals.marginPercent.toFixed(1) + "%"
                      : "–"}
                  </div>
                </div>
              </div>

              {!profit?.series?.length && (
                <div className="mt-4 text-xs text-slate-500">
                  No profit history yet. Once orders start coming in and your
                  sync jobs run, this section will show daily numbers.
                </div>
              )}
            </div>
          </div>
        );
      }

      // --------- Runs section ----------
      function RunsSection({ runs }) {
        const rows = runs ?? [];

        return (
          <div className="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5">
            <div className="flex items-center justify-between mb-3 gap-2">
              <h2 className="text-sm font-semibold">Recent import runs</h2>
              <span className="text-[11px] text-slate-500">
                Latest 20 runs
              </span>
            </div>

            {rows.length === 0 ? (
              <div className="text-xs text-slate-500">
                No runs recorded yet. Trigger your first import using the form
                above.
              </div>
            ) : (
              <div className="overflow-auto scrollbar-thin max-h-[420px]">
                <table className="w-full text-xs">
                  <thead className="text-[11px] uppercase text-slate-500 border-b border-slate-800">
                    <tr>
                      <th className="py-2 text-left pr-2">Keyword</th>
                      <th className="py-2 text-left pr-2">Source</th>
                      <th className="py-2 text-left pr-2">Created</th>
                      <th className="py-2 text-left pr-2">Status</th>
                      <th className="py-2 text-left pr-2">Started</th>
                      <th className="py-2 text-left pr-2">Finished</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-800/80">
                    {rows.map((r) => (
                      <tr key={r.id ?? r.startedAt}>
                        <td className="py-2 pr-2 text-slate-100">
                          {r.keyword}
                        </td>
                        <td className="py-2 pr-2 text-slate-400">
                          {r.source}
                        </td>
                        <td className="py-2 pr-2 text-slate-100">
                          {r.createdCount ?? 0}
                        </td>
                        <td className="py-2 pr-2">
                          <span
                            className={classNames(
                              "inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium",
                              r.status === "success"
                                ? "bg-emerald-900/60 text-emerald-300 border border-emerald-700/70"
                                : r.status === "error"
                                ? "bg-rose-900/60 text-rose-300 border border-rose-700/70"
                                : "bg-slate-800 text-slate-200 border border-slate-600"
                            )}
                          >
                            {r.status || "unknown"}
                          </span>
                        </td>
                        <td className="py-2 pr-2 text-slate-400">
                          {formatDate(r.startedAt || r.createdAt)}
                        </td>
                        <td className="py-2 pr-2 text-slate-400">
                          {formatDate(r.finishedAt)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        );
      }

      // --------- Profit section ----------
      function ProfitSection({ profit }) {
        const series = profit?.series ?? [];

        return (
          <div className="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5 flex flex-col gap-4">
            <div className="flex items-center justify-between gap-2">
              <h2 className="text-sm font-semibold">Profit & pricing details</h2>
              <span className="text-[11px] text-slate-500">
                Based on recent synced products
              </span>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-4 gap-4 text-sm">
              <div>
                <div className="text-xs text-slate-500 uppercase">Revenue</div>
                <div className="text-lg font-semibold">
                  $
                  {profit?.totals?.revenue != null
                    ? profit.totals.revenue.toFixed(2)
                    : "0.00"}
                </div>
              </div>
              <div>
                <div className="text-xs text-slate-500 uppercase">Cost</div>
                <div className="text-lg font-semibold">
                  $
                  {profit?.totals?.cost != null
                    ? profit.totals.cost.toFixed(2)
                    : "0.00"}
                </div>
              </div>
              <div>
                <div className="text-xs text-slate-500 uppercase">
                  Profit
                </div>
                <div className="text-lg font-semibold text-emerald-400">
                  $
                  {profit?.totals?.profit != null
                    ? profit.totals.profit.toFixed(2)
                    : "0.00"}
                </div>
              </div>
              <div>
                <div className="text-xs text-slate-500 uppercase">
                  Margin
                </div>
                <div className="text-lg font-semibold">
                  {profit?.totals?.marginPercent != null
                    ? profit.totals.marginPercent.toFixed(1) + "%"
                    : "–"}
                </div>
              </div>
            </div>

            {series.length === 0 ? (
              <div className="text-xs text-slate-500">
                No per-day profit data yet. Once you have enough synced orders,
                this section can be extended to show daily breakdowns and charts.
              </div>
            ) : (
              <div className="overflow-auto scrollbar-thin max-h-[420px]">
                <table className="w-full text-xs">
                  <thead className="text-[11px] uppercase text-slate-500 border-b border-slate-800">
                    <tr>
                      <th className="py-2 text-left pr-2">Date</th>
                      <th className="py-2 text-left pr-2">Revenue</th>
                      <th className="py-2 text-left pr-2">Cost</th>
                      <th className="py-2 text-left pr-2">Profit</th>
                      <th className="py-2 text-left pr-2">Margin</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-800/80">
                    {series.map((row) => (
                      <tr key={row.date}>
                        <td className="py-2 pr-2 text-slate-100">
                          {row.date}
                        </td>
                        <td className="py-2 pr-2">
                          ${row.revenue?.toFixed(2) ?? "0.00"}
                        </td>
                        <td className="py-2 pr-2">
                          ${row.cost?.toFixed(2) ?? "0.00"}
                        </td>
                        <td className="py-2 pr-2 text-emerald-400">
                          ${row.profit?.toFixed(2) ?? "0.00"}
                        </td>
                        <td className="py-2 pr-2">
                          {row.marginPercent != null
                            ? row.marginPercent.toFixed(1) + "%"
                            : "–"}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        );
      }

      // --------- Alerts section ----------
      function AlertsSection({ alerts }) {
        const list = alerts ?? [];

        return (
          <div className="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5 flex flex-col gap-3">
            <div className="flex items-center justify-between gap-2">
              <h2 className="text-sm font-semibold">System alerts</h2>
              <span className="text-[11px] text-slate-500">
                Auto-generated by your sync jobs
              </span>
            </div>

            {list.length === 0 ? (
              <div className="text-xs text-slate-500">
                No alerts right now. Price / stock issues or sync errors will
                appear here.
              </div>
            ) : (
              <div className="flex flex-col gap-2 max-h-[420px] overflow-auto scrollbar-thin">
                {list.map((a) => (
                  <div
                    key={a.id ?? a.createdAt}
                    className={classNames(
                      "rounded-xl border px-3 py-2 text-xs flex flex-col gap-1",
                      a.type === "error"
                        ? "border-rose-700/80 bg-rose-950/40 text-rose-100"
                        : a.type === "warning"
                        ? "border-amber-700/80 bg-amber-950/40 text-amber-100"
                        : "border-sky-700/80 bg-sky-950/40 text-sky-100"
                    )}
                  >
                    <div className="flex items-center justify-between gap-2">
                      <span className="font-medium capitalize">
                        {a.type || "info"}
                      </span>
                      <span className="text-[10px] opacity-80">
                        {formatDate(a.createdAt)}
                      </span>
                    </div>
                    <div className="leading-snug">{a.message}</div>
                    {a.contextKeyword && (
                      <div className="text-[10px] opacity-80">
                        Keyword:{" "}
                        <span className="font-mono">
                          {a.contextKeyword}
                        </span>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }

      // --------- Settings / sync section ----------
      function SettingsSection({ autoRefresh, setAutoRefresh }) {
        return (
          <div className="bg-slate-900/80 border border-slate-800 rounded-2xl p-4 sm:p-5 flex flex-col gap-4">
            <div className="flex items-center justify-between">
              <h2 className="text-sm font-semibold">Dashboard settings</h2>
            </div>

            <div className="flex items-center justify-between gap-3">
              <div className="flex flex-col gap-1">
                <div className="text-sm text-slate-100">Auto-refresh data</div>
                <div className="text-xs text-slate-500">
                  When enabled, overview & profit stats will refresh every 60
                  seconds.
                </div>
              </div>
              <button
                type="button"
                onClick={() => setAutoRefresh((v) => !v)}
                className={classNames(
                  "inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border",
                  autoRefresh
                    ? "bg-emerald-500 text-emerald-950 border-emerald-400"
                    : "bg-slate-800 border-slate-600 text-slate-100"
                )}
              >
                {autoRefresh ? "On" : "Off"}
              </button>
            </div>

            <div className="text-[11px] text-slate-500">
              Backend sync schedules (cron jobs, background workers, etc.) are
              configured on the server / Railway side. This page is focused on
              visibility & manual control.
            </div>
          </div>
        );
      }

      // --------- Root App ----------
      function App() {
        const [tab, setTab] = useState("overview");
        const [overview, setOverview] = useState(null);
        const [runs, setRuns] = useState(null);
        const [profit, setProfit] = useState(null);
        const [alerts, setAlerts] = useState(null);
        const [loading, setLoading] = useState(false);
        const [autoRefresh, setAutoRefresh] = useState(true);

        async function loadAll({ lightOnly = false } = {}) {
          setLoading(true);

          const promises = [];

          // overview & profit always
          promises.push(
            safeJsonFetch("/api/dashboard/overview").then((res) => {
              if (res.ok) setOverview(res.data);
            })
          );
          promises.push(
            safeJsonFetch("/api/dashboard/profit").then((res) => {
              if (res.ok) setProfit(res.data);
            })
          );

          if (!lightOnly) {
            promises.push(
              safeJsonFetch("/api/dashboard/runs").then((res) => {
                if (res.ok) setRuns(res.data?.runs ?? res.data);
              })
            );
            promises.push(
              safeJsonFetch("/api/dashboard/alerts").then((res) => {
                if (res.ok) setAlerts(res.data?.alerts ?? res.data);
              })
            );
          }

          await Promise.all(promises);
          setLoading(false);
        }

        useEffect(() => {
          loadAll();

          if (!autoRefresh) return;

          const id = setInterval(() => {
            loadAll({ lightOnly: true });
          }, 60000);

          return () => clearInterval(id);
        }, [autoRefresh]);

        function handleImported() {
          // Reload everything when a manual import finishes
          loadAll();
        }

        return (
          <div className="min-h-screen flex flex-col">
            {/* Top bar */}
            <header className="border-b border-slate-800/80 bg-slate-950/90 backdrop-blur">
              <div className="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between gap-3">
                <div className="flex items-center gap-3">
                  <div className="h-8 w-8 rounded-xl bg-sky-500 flex items-center justify-center text-xs font-black">
                    DB
                  </div>
                  <div className="flex flex-col">
                    <span className="text-sm font-semibold">
                      DropBopp Dashboard
                    </span>
                    <span className="text-[11px] text-slate-400">
                      AI dropshipping control panel
                    </span>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  {loading && (
                    <span className="text-[11px] text-slate-400">
                      Refreshing…
                    </span>
                  )}
                  <button
                    type="button"
                    onClick={() => loadAll()}
                    className="text-[11px] px-3 py-1 rounded-full border border-slate-700 text-slate-200 hover:bg-slate-800"
                  >
                    Refresh
                  </button>
                  <Tabs active={tab} onChange={setTab} />
                </div>
              </div>
            </header>

            {/* Main content */}
            <main className="flex-1">
              <div className="mx-auto max-w-6xl px-4 py-5 flex flex-col gap-5">
                {/* Shared manual import panel at the top */}
                <ManualImportPanel onImported={handleImported} />

                {/* Tab content */}
                {tab === "overview" && (
                  <OverviewSection overview={overview} profit={profit} />
                )}
                {tab === "runs" && <RunsSection runs={runs} />}
                {tab === "profit" && <ProfitSection profit={profit} />}
                {tab === "alerts" && <AlertsSection alerts={alerts} />}
                {tab === "settings" && (
                  <SettingsSection
                    autoRefresh={autoRefresh}
                    setAutoRefresh={setAutoRefresh}
                  />
                )}
              </div>
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
