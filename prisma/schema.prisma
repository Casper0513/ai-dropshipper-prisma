generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum Supplier {
  amazon
  aliexpress
  walmart
  cj
  system
  manual
}

enum FulfillmentStatus {
  pending
  ordered
  shipped
  delivered
  failed
}

//////////////////////
// RUNS
//////////////////////

model Run {
  id            Int          @id @default(autoincrement())
  keyword       String
  markupPercent Float
  source        String
  status        String
  createdCount  Int          @default(0)
  errorMessage  String?
  startedAt     DateTime     @default(now())
  finishedAt    DateTime?

  products      ProductLog[]
}

//////////////////////
// PRODUCT LOGS
//////////////////////

model ProductLog {
  id               Int      @id @default(autoincrement())

  run              Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  runId            Int

  asin             String?
  title            String

  // Pricing
  sourcePrice      Float?
  finalPrice       Float?
  currency         String   @default("USD")

  // Shopify references
  shopifyProductId String?
  shopifyHandle    String?

  // Profit (used by dashboard + fulfillment accounting)
  profitAtSale     Float?

  createdAt        DateTime @default(now())
}

//////////////////////
// SYNCED VARIANTS
//////////////////////

model SyncedVariant {
  id               Int      @id @default(autoincrement())

  // Supplier identifiers
  asin             String?
  sku              String?

  // Supplier source
  source           Supplier

  // Shopify mapping
  shopifyProductId String
  shopifyVariantId String
  shopifyHandle    String?

  // Pricing (USED FOR AMAZON / ALI ONLY)
  currentPrice     Float?
  lastCostPrice    Float?

  // Dropshipping-safe stock
  inStock          Boolean  @default(true)
  deleted          Boolean  @default(false)

  // CJ mapping (FULFILLMENT ONLY)
  cjProductId      String?
  cjVariantId      String?

  // Optional state tracking
  fulfillmentStatus FulfillmentStatus?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

//////////////////////
// FULFILLMENT ORDERS
//////////////////////

model FulfillmentOrder {
  id                    Int      @id @default(autoincrement())

  // Shopify
  shopifyOrderId        String
  shopifyLineItemId     String
  shopifySku            String?

  // Supplier
  supplier              Supplier

  // CJ data
  cjOrderId             String?
  cjTrackingNumber      String?

  // Shopify fulfillment
  shopifyFulfillmentSent Boolean @default(false)

  // âœ… PROFIT ACCOUNTING (NEW)
  salePrice              Float?   // Shopify line item price * qty
  supplierCost           Float?   // CJ product + shipping
  shippingCost           Float?
  profit                 Float?
  
  // Metadata for address / qty snapshot
  metaJson              String?

  status                FulfillmentStatus @default(pending)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([shopifyOrderId])
}



